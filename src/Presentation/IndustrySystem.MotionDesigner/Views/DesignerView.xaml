<UserControl x:Class="IndustrySystem.MotionDesigner.Views.DesignerView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:controls="clr-namespace:IndustrySystem.MotionDesigner.Controls"
             xmlns:prism="http://prismlibrary.com/"
             prism:ViewModelLocator.AutoWireViewModel="True"
             Background="{DynamicResource MaterialDesignPaper}">

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="250"/>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="280"/>
        </Grid.ColumnDefinitions>

        <materialDesign:Card Grid.Column="0" Margin="8" materialDesign:ElevationAssist.Elevation="Dp2" UniformCornerRadius="8">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <Border Grid.Row="0" Background="{DynamicResource PrimaryHueMidBrush}" Padding="12,8">
                    <TextBlock Text="Action Toolbox" Foreground="White" FontWeight="SemiBold"/>
                </Border>

                <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="8">
                        <TextBlock Text="Motor Control" FontWeight="SemiBold" Margin="0,8,0,4"/>
                        <ItemsControl ItemsSource="{Binding MotorActions}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Button Style="{StaticResource MaterialDesignOutlinedButton}"
                                           Command="{Binding DataContext.AddNodeCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                           CommandParameter="{Binding}"
                                           HorizontalContentAlignment="Left" Margin="0,2" Padding="8,6">
                                        <StackPanel Orientation="Horizontal">
                                            <materialDesign:PackIcon Kind="{Binding IconKind}" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                            <TextBlock Text="{Binding DisplayName}" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <TextBlock Text="IO Control" FontWeight="SemiBold" Margin="0,12,0,4"/>
                        <ItemsControl ItemsSource="{Binding IoActions}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Button Style="{StaticResource MaterialDesignOutlinedButton}"
                                           Command="{Binding DataContext.AddNodeCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                           CommandParameter="{Binding}"
                                           HorizontalContentAlignment="Left" Margin="0,2" Padding="8,6">
                                        <StackPanel Orientation="Horizontal">
                                            <materialDesign:PackIcon Kind="{Binding IconKind}" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                            <TextBlock Text="{Binding DisplayName}" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <TextBlock Text="Robot Control" FontWeight="SemiBold" Margin="0,12,0,4"/>
                        <ItemsControl ItemsSource="{Binding RobotActions}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Button Style="{StaticResource MaterialDesignOutlinedButton}"
                                           Command="{Binding DataContext.AddNodeCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                           CommandParameter="{Binding}"
                                           HorizontalContentAlignment="Left" Margin="0,2" Padding="8,6">
                                        <StackPanel Orientation="Horizontal">
                                            <materialDesign:PackIcon Kind="{Binding IconKind}" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                            <TextBlock Text="{Binding DisplayName}" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <TextBlock Text="Flow Control" FontWeight="SemiBold" Margin="0,12,0,4"/>
                        <ItemsControl ItemsSource="{Binding FlowActions}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Button Style="{StaticResource MaterialDesignOutlinedButton}"
                                           Command="{Binding DataContext.AddNodeCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                           CommandParameter="{Binding}"
                                           HorizontalContentAlignment="Left" Margin="0,2" Padding="8,6">
                                        <StackPanel Orientation="Horizontal">
                                            <materialDesign:PackIcon Kind="{Binding IconKind}" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                            <TextBlock Text="{Binding DisplayName}" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <TextBlock Text="Logic Control" FontWeight="SemiBold" Margin="0,12,0,4" Foreground="#E91E63"/>
                        <ItemsControl ItemsSource="{Binding LogicActions}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Button Style="{StaticResource MaterialDesignOutlinedButton}"
                                           Command="{Binding DataContext.AddNodeCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                           CommandParameter="{Binding}"
                                           HorizontalContentAlignment="Left" Margin="0,2" Padding="8,6">
                                        <StackPanel Orientation="Horizontal">
                                            <materialDesign:PackIcon Kind="{Binding IconKind}" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                            <TextBlock Text="{Binding DisplayName}" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </ScrollViewer>
            </Grid>
        </materialDesign:Card>

        <Grid Grid.Column="1">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <Border Grid.Row="0" Background="{DynamicResource MaterialDesignToolBarBackground}" Padding="8">
                <StackPanel Orientation="Horizontal">
                    <Button Style="{StaticResource MaterialDesignIconButton}" Command="{Binding NewProgramCommand}" ToolTip="New">
                        <materialDesign:PackIcon Kind="FileOutline"/>
                    </Button>
                    <Button Style="{StaticResource MaterialDesignIconButton}" Command="{Binding OpenProgramCommand}" ToolTip="Open">
                        <materialDesign:PackIcon Kind="FolderOpenOutline"/>
                    </Button>
                    <Button Style="{StaticResource MaterialDesignIconButton}" Command="{Binding SaveProgramCommand}" ToolTip="Save">
                        <materialDesign:PackIcon Kind="ContentSave"/>
                    </Button>
                    <Button Style="{StaticResource MaterialDesignIconButton}" Command="{Binding ExportCommand}" ToolTip="Export">
                        <materialDesign:PackIcon Kind="Export"/>
                    </Button>

                    <Separator Margin="8,0"/>

                    <Button Style="{StaticResource MaterialDesignIconButton}" Command="{Binding DeleteSelectedCommand}" ToolTip="Delete">
                        <materialDesign:PackIcon Kind="Delete"/>
                    </Button>
                    <Button Style="{StaticResource MaterialDesignIconButton}" Command="{Binding ClearAllCommand}" ToolTip="Clear">
                        <materialDesign:PackIcon Kind="DeleteSweep"/>
                    </Button>

                    <Separator Margin="8,0"/>

                    <Button Style="{StaticResource MaterialDesignRaisedButton}" Command="{Binding RunCommand}" 
                           Background="#4CAF50" ToolTip="Run" Padding="12,4">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="Play" Margin="0,0,4,0"/>
                            <TextBlock Text="Run"/>
                        </StackPanel>
                    </Button>
                    <Button Style="{StaticResource MaterialDesignIconButton}" Command="{Binding PauseCommand}" ToolTip="Pause">
                        <materialDesign:PackIcon Kind="Pause"/>
                    </Button>
                    <Button Style="{StaticResource MaterialDesignIconButton}" Command="{Binding StopCommand}" Foreground="#F44336" ToolTip="Stop">
                        <materialDesign:PackIcon Kind="Stop"/>
                    </Button>
                    <Button Style="{StaticResource MaterialDesignIconButton}" Command="{Binding StepCommand}" ToolTip="Step">
                        <materialDesign:PackIcon Kind="DebugStepOver"/>
                    </Button>
                </StackPanel>
            </Border>

            <Border Grid.Row="1" Background="#F5F5F5" ClipToBounds="True">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="347*"/>
                        <ColumnDefinition Width="2653*"/>
                    </Grid.ColumnDefinitions>
                    <!-- 使用 ProgramCanvasControl -->
                    <controls:ProgramCanvasControl 
                        ZoomLevel="{Binding ZoomLevel}"
                        NodeSelected="OnNodeSelected"
                        SelectionCleared="OnSelectionCleared"
                        ConnectionCreated="OnConnectionCreated"
                        ItemDropped="OnItemDropped"
                        ConnectionPathsUpdateRequested="OnConnectionPathsUpdateRequested" Grid.ColumnSpan="2"/>

                    <!-- Zoom Controls -->
                    <!--<StackPanel HorizontalAlignment="Right" VerticalAlignment="Top" 
                               Margin="0,8,16,0" Orientation="Horizontal">
                        <materialDesign:Card Padding="4" UniformCornerRadius="4">
                            <StackPanel Orientation="Horizontal">
                                <Button Style="{StaticResource MaterialDesignIconButton}" 
                                       Command="{Binding ZoomOutCommand}" ToolTip="Zoom Out" Width="32" Height="32">
                                    <materialDesign:PackIcon Kind="MagnifyMinus" Width="18" Height="18"/>
                                </Button>
                                <TextBlock Text="{Binding ZoomPercentage}" VerticalAlignment="Center" 
                                          Width="50" TextAlignment="Center" FontWeight="SemiBold"/>
                                <Button Style="{StaticResource MaterialDesignIconButton}" 
                                       Command="{Binding ZoomInCommand}" ToolTip="Zoom In" Width="32" Height="32">
                                    <materialDesign:PackIcon Kind="MagnifyPlus" Width="18" Height="18"/>
                                </Button>
                                <Rectangle Width="1" Fill="#E0E0E0" Margin="4,4"/>
                                <Button Style="{StaticResource MaterialDesignIconButton}" 
                                       Command="{Binding ZoomResetCommand}" ToolTip="Reset Zoom (100%)" Width="32" Height="32">
                                    <materialDesign:PackIcon Kind="MagnifyClose" Width="18" Height="18"/>
                                </Button>
                                <Button Style="{StaticResource MaterialDesignIconButton}" 
                                       Command="{Binding ZoomFitCommand}" ToolTip="Fit to View" Width="32" Height="32">
                                    <materialDesign:PackIcon Kind="FitToPage" Width="18" Height="18"/>
                                </Button>
                            </StackPanel>
                        </materialDesign:Card>
                    </StackPanel>-->
                </Grid>
            </Border>

            <Border Grid.Row="2" Background="{DynamicResource MaterialDesignToolBarBackground}" Padding="8,4">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="State: "/>
                        <TextBlock Text="{Binding ExecutionState}" FontWeight="SemiBold"/>
                    </StackPanel>

                    <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Center">
                        <TextBlock Text="Nodes: "/>
                        <TextBlock Text="{Binding Nodes.Count}"/>
                        <TextBlock Text="  |  Connections: " Margin="8,0,0,0"/>
                        <TextBlock Text="{Binding Connections.Count}"/>
                    </StackPanel>

                    <ProgressBar Grid.Column="2" Width="150" Height="6" Value="{Binding ExecutionProgress}"
                                Visibility="{Binding IsRunning, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                </Grid>
            </Border>
        </Grid>

        <materialDesign:Card Grid.Column="2" Margin="8" materialDesign:ElevationAssist.Elevation="Dp2" UniformCornerRadius="8">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <Border Grid.Row="0" Background="{DynamicResource PrimaryHueMidBrush}" Padding="12,8">
                    <TextBlock Text="Properties" Foreground="White" FontWeight="SemiBold"/>
                </Border>

                <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="12" Visibility="{Binding HasSelectedNode, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <TextBlock Text="Basic Info" FontWeight="SemiBold" Margin="0,0,0,8"/>

                        <TextBox materialDesign:HintAssist.Hint="Name" materialDesign:HintAssist.IsFloating="True"
                                Text="{Binding SelectedNode.Name, UpdateSourceTrigger=PropertyChanged}" Margin="0,0,0,8"/>

                        <TextBox materialDesign:HintAssist.Hint="Description" materialDesign:HintAssist.IsFloating="True"
                                Text="{Binding SelectedNode.Description, UpdateSourceTrigger=PropertyChanged}"
                                TextWrapping="Wrap" AcceptsReturn="True" MinHeight="60" Margin="0,0,0,8"/>

                        <CheckBox Content="Enabled" IsChecked="{Binding SelectedNode.IsEnabled}" Margin="0,0,0,16"/>

                        <TextBlock Text="Parameters" FontWeight="SemiBold" Margin="0,0,0,8"/>
                        <ContentControl Content="{Binding ParameterEditor}"/>

                        <Expander Header="Advanced" Margin="0,16,0,0">
                            <StackPanel Margin="0,8,0,0">
                                <TextBox materialDesign:HintAssist.Hint="Timeout (ms)" materialDesign:HintAssist.IsFloating="True"
                                        Text="{Binding SelectedNode.TimeoutMs}" Margin="0,0,0,8"/>
                                <TextBox materialDesign:HintAssist.Hint="Retry Count" materialDesign:HintAssist.IsFloating="True"
                                        Text="{Binding SelectedNode.RetryCount}" Margin="0,0,0,8"/>
                                <ComboBox materialDesign:HintAssist.Hint="Error Handling" materialDesign:HintAssist.IsFloating="True"
                                         ItemsSource="{Binding ErrorHandlingOptions}" SelectedItem="{Binding SelectedNode.ErrorHandling}"/>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>

                <StackPanel Grid.Row="1" VerticalAlignment="Center" HorizontalAlignment="Center"
                           Visibility="{Binding HasSelectedNode, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=Inverse}">
                    <materialDesign:PackIcon Kind="InformationOutline" Width="48" Height="48" HorizontalAlignment="Center" Opacity="0.3"/>
                    <TextBlock Text="Select a node to view properties" Opacity="0.5" Margin="0,8,0,0"/>
                </StackPanel>
            </Grid>
        </materialDesign:Card>
    </Grid>
</UserControl>

