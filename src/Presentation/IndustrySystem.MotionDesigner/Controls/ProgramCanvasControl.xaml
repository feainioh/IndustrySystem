<UserControl x:Class="IndustrySystem.MotionDesigner.Controls.ProgramCanvasControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:controls="clr-namespace:IndustrySystem.MotionDesigner.Controls"
             xmlns:viewModels="clr-namespace:IndustrySystem.MotionDesigner.ViewModels"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             Background="Transparent">
    
    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        
        <!-- Grid Pattern Background -->
        <DrawingBrush x:Key="GridBrush" TileMode="Tile" 
                      Viewport="0,0,20,20" ViewportUnits="Absolute">
            <DrawingBrush.Drawing>
                <DrawingGroup>
                    <GeometryDrawing>
                        <GeometryDrawing.Geometry>
                            <RectangleGeometry Rect="0,0,20,20"/>
                        </GeometryDrawing.Geometry>
                        <GeometryDrawing.Brush>
                            <SolidColorBrush Color="#F5F5F5"/>
                        </GeometryDrawing.Brush>
                    </GeometryDrawing>
                    <GeometryDrawing>
                        <GeometryDrawing.Geometry>
                            <GeometryGroup>
                                <LineGeometry StartPoint="0,0" EndPoint="0,20"/>
                                <LineGeometry StartPoint="0,0" EndPoint="20,0"/>
                            </GeometryGroup>
                        </GeometryDrawing.Geometry>
                        <GeometryDrawing.Pen>
                            <Pen Brush="#E0E0E0" Thickness="0.5"/>
                        </GeometryDrawing.Pen>
                    </GeometryDrawing>
                </DrawingGroup>
            </DrawingBrush.Drawing>
        </DrawingBrush>
    </UserControl.Resources>
    
    <Grid x:Name="RootGrid">
        <ScrollViewer x:Name="MainScrollViewer" 
                      HorizontalScrollBarVisibility="Auto" 
                      VerticalScrollBarVisibility="Auto"
                      ScrollChanged="OnScrollChanged">
            <Canvas x:Name="DesignerCanvas" 
                    Width="3000" Height="3000"
                    Background="Transparent" 
                    AllowDrop="True"
                    Drop="OnCanvasDrop" 
                    DragOver="OnCanvasDragOver"
                    MouseLeftButtonDown="OnCanvasMouseLeftButtonDown"
                    MouseMove="OnCanvasMouseMove"
                    MouseLeftButtonUp="OnCanvasMouseLeftButtonUp"
                    MouseWheel="OnCanvasMouseWheel">
                
                <Canvas.LayoutTransform>
                    <ScaleTransform ScaleX="{Binding ZoomLevel, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                    ScaleY="{Binding ZoomLevel, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                </Canvas.LayoutTransform>
                
                <!-- Background Grid Pattern -->
                <Rectangle Width="3000" Height="3000" 
                           Fill="{StaticResource GridBrush}" 
                           IsHitTestVisible="False"/>
                
                <!-- TEST: Static connection line for debugging --><!--
                <Line X1="200" Y1="200" X2="500" Y2="200" 
                      Stroke="Red" StrokeThickness="5"
                      StrokeDashArray="4,2"/>-->
                <!--<Ellipse Canvas.Left="195" Canvas.Top="195" Width="10" Height="10" Fill="Red"/>
                <Ellipse Canvas.Left="495" Canvas.Top="195" Width="10" Height="10" Fill="Red"/>
                <TextBlock Canvas.Left="300" Canvas.Top="210" Text="TEST LINE" Foreground="Red" FontWeight="Bold"/>-->
                
                <!-- Connection Lines Layer (behind nodes) -->
                <ItemsControl x:Name="ConnectionsLayer"
                              ItemsSource="{Binding DataContext.Connections, RelativeSource={RelativeSource AncestorType=UserControl}}"
                              IsHitTestVisible="False">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <Canvas IsItemsHost="True"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate DataType="{x:Type viewModels:ConnectionViewModel}">
                            <Canvas>
                                <!-- Connection Path -->
                                <Path Stroke="{DynamicResource PrimaryHueMidBrush}" 
                                      StrokeThickness="2"
                                      Fill="Transparent">
                                    <Path.Style>
                                        <Style TargetType="Path">
                                            <Setter Property="Data" Value="{Binding PathData}"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsHighlighted}" Value="True">
                                                    <Setter Property="Stroke" Value="#4CAF50"/>
                                                    <Setter Property="StrokeThickness" Value="3"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Path.Style>
                                </Path>
                                <!-- Arrow Head -->
                                <Path Fill="{DynamicResource PrimaryHueMidBrush}">
                                    <Path.Style>
                                        <Style TargetType="Path">
                                            <Setter Property="Data" Value="{Binding ArrowData}"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsHighlighted}" Value="True">
                                                    <Setter Property="Fill" Value="#4CAF50"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Path.Style>
                                </Path>
                                <!-- Execution Order Label -->
                                <Border Canvas.Left="{Binding ArrowX}" 
                                        Canvas.Top="{Binding ArrowY}"
                                        Background="White" 
                                        CornerRadius="8" 
                                        Padding="4,2"
                                        Margin="-20,-20,0,0"
                                        Visibility="{Binding IsHighlighted, Converter={StaticResource BooleanToVisibilityConverter}}">
                                    <TextBlock Text="{Binding ExecutionOrder}" 
                                               FontSize="10" 
                                               FontWeight="Bold"
                                               Foreground="{DynamicResource PrimaryHueMidBrush}"/>
                                </Border>
                            </Canvas>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
                
                <!-- Nodes Layer -->
                <ItemsControl x:Name="NodesLayer"
                              ItemsSource="{Binding DataContext.Nodes, RelativeSource={RelativeSource AncestorType=UserControl}}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <Canvas IsItemsHost="True"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemContainerStyle>
                        <Style TargetType="ContentPresenter">
                            <Setter Property="Canvas.Left" Value="{Binding X}"/>
                            <Setter Property="Canvas.Top" Value="{Binding Y}"/>
                        </Style>
                    </ItemsControl.ItemContainerStyle>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate DataType="{x:Type viewModels:ActionNodeViewModel}">
                            <controls:ActionNodeControl/>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
                
                <!-- Temporary connections will be added programmatically here -->
            </Canvas>
        </ScrollViewer>
        
        <!-- Minimap / Thumbnail Navigator -->
        <Border x:Name="MinimapBorder" Opacity=".5"
                HorizontalAlignment="Left" VerticalAlignment="Bottom"
                Margin="16" Width="200" Height="150"
                Background="#F0FFFFFF" BorderBrush="#CCCCCC" BorderThickness="2"
                CornerRadius="4">
            <Border.Effect>
                <DropShadowEffect Color="Black" BlurRadius="8" ShadowDepth="2" Opacity="0.3"/>
            </Border.Effect>
            <Grid>
                <!-- Minimap Canvas -->
                <Canvas x:Name="MinimapCanvas" ClipToBounds="True">
                    <!-- Minimap content will be rendered here -->
                    <Rectangle x:Name="ViewportRect" 
                               Stroke="{DynamicResource PrimaryHueMidBrush}" 
                               StrokeThickness="2"
                               Fill="Transparent"
                               MouseLeftButtonDown="OnMinimapMouseDown"
                               MouseMove="OnMinimapMouseMove"
                               Cursor="Hand"/>
                </Canvas>
                
                <!-- Toggle Minimap Button -->
                <Button x:Name="ToggleMinimapButton"
                        Style="{StaticResource MaterialDesignIconButton}"
                        HorizontalAlignment="Right" VerticalAlignment="Top"
                        Width="24" Height="24" Margin="4"
                        Click="OnToggleMinimapClick"
                        ToolTip="Toggle Minimap">
                    <materialDesign:PackIcon Kind="EyeOff" Width="16" Height="16"/>
                </Button>
            </Grid>
        </Border>
        
        <!-- Floating Zoom Controls -->
        <materialDesign:Card x:Name="ZoomControls"
                             HorizontalAlignment="Left" VerticalAlignment="Top"
                             Margin="16" Padding="4"
                             UniformCornerRadius="4">
            <StackPanel>
                <Button Style="{StaticResource MaterialDesignIconButton}"
                        Click="OnZoomInClick" ToolTip="Zoom In" 
                        Width="32" Height="32">
                    <materialDesign:PackIcon Kind="Plus" Width="20" Height="20"/>
                </Button>
                <TextBlock Text="{Binding ZoomLevel, RelativeSource={RelativeSource AncestorType=UserControl}, StringFormat={}{0:P0}}" 
                           HorizontalAlignment="Center" 
                           FontSize="10" FontWeight="Bold"
                           Margin="0,2"/>
                <Button Style="{StaticResource MaterialDesignIconButton}"
                        Click="OnZoomOutClick" ToolTip="Zoom Out"
                        Width="32" Height="32">
                    <materialDesign:PackIcon Kind="Minus" Width="20" Height="20"/>
                </Button>
                <Rectangle Height="1" Fill="#E0E0E0" Margin="4,2"/>
                <Button Style="{StaticResource MaterialDesignIconButton}"
                        Click="OnZoomResetClick" ToolTip="Reset Zoom (100%)"
                        Width="32" Height="32">
                    <materialDesign:PackIcon Kind="Restore" Width="18" Height="18"/>
                </Button>
                <Button Style="{StaticResource MaterialDesignIconButton}"
                        Click="OnZoomFitClick" ToolTip="Fit to View"
                        Width="32" Height="32">
                    <materialDesign:PackIcon Kind="FitToPage" Width="18" Height="18"/>
                </Button>
            </StackPanel>
        </materialDesign:Card>
    </Grid>
</UserControl>
